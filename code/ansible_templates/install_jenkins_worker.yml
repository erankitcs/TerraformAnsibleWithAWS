---
- hosts: " {{ passed_in_hosts}} "
  become: yes
  remote-user: ec2-user
  become-user: root
  tasks:
    - name: Generate SSH Keypair
      openssh_keypair:
        path: /home/ec2-user/.ssh/id_rsa
        type: rsa
        size: 2048
        group: ec2-user
        owner: ec2-user
    - name: Add own key to authorized_keys file
      shell: "cat /home/ec2-user/.ssh/id_rsa >> /home/ec2-user/.ssh/authorized_keys && chmod 600 /home/ec2-user/.ssh/authorized_keys"

    - name: Copy over Jenkins Worker Node creation payload xml
      vars: 
        ipv4: "{{ ansible_default_ipv4.address }}"
      template:
        src: node.j2
        dest: /home/ec2-user/node.xml
        owner: ec2-user
        mode: '0644'
    - name: read Generated private key id rsa
      slurp:
        src: /home/ec2-user/.ssh/id_rsa
      register: pkey
    - name: Copy over creds.xml and create Jenkins credential
      vars:
        priv_key: "{{ pkey['content'] | b64decode}}"
